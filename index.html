<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç‡’çƒé¾œç¥ˆæ™´ v2.3-fix</title>
  <style>
    body{font-family:"Noto Sans TC",Arial,sans-serif;margin:0;display:flex;flex-direction:column;align-items:center;background:#fafafa}
    #controls{display:flex;gap:1rem;padding:1rem;flex-wrap:wrap;justify-content:center}
    label,select{font-size:1.2rem}
    input{margin-left:6px;padding:10px 16px;font-size:1.2rem;border:1px solid #ccc;border-radius:6px}
    button{padding:18px 36px;font-size:1.6rem;font-weight:700;border:none;border-radius:12px;cursor:pointer;background:#4caf50;color:#fff;transition:background .2s}
    button:hover{background:#43a047}
    #burnBtn{background:#e65100}
    #burnBtn:hover{background:#bf360c}
    #resetBtn{background:#546e7a}
    #resetBtn:hover{background:#37474f}
    canvas{border:3px solid #ccc;box-shadow:0 6px 15px rgba(0,0,0,.2);margin-bottom:1rem}
  </style>
</head>
<body>
  <div id="controls">
    <label>æ—¥æœŸ <input id="dateInput" type="date"></label>
    <label>æ™‚é–“ <input id="timeInput" type="time"></label>
    <label>åœ°é» <input id="locInput" type="text" placeholder="ç¥ˆæ™´åœ°é»"></label>
    <label>é¢¨æ ¼
      <select id="styleSelect">
        <option value="orig">ä¸€èˆ¬</option>
        <option value="hand">æ‰‹ç¹ª</option>
        <option value="mix">éš¨æ©Ÿæ··åˆ</option>
      </select>
    </label>
    <button id="drawBtn">ç•« ğŸ¢</button>
    <button id="burnBtn">ç‡’ ğŸ”¥</button>
    <button id="resetBtn">é‡ä¾† â†º</button>
  </div>
  <canvas id="paper" width="800" height="800"></canvas>

<script>
/* ---------- ä¸»è¦ä¿®æ­£ ---------- *
1. ç§»é™¤ burnStep å…§å¤šé¤˜çš„ã€Œ)ã€ï¼Œä¸¦è®“ burnStep è‡ªå·±æ’ç¨‹ä¸‹ä¸€å¹€
2. burnBtn äº‹ä»¶é¸å–å™¨å¤šäº†ä¸€å€‹å¼•è™Ÿï¼Œä¿®æ­£ç‚º 'burnBtn'
3. è®“ burnRAF æ­£ç¢ºå„²å­˜ requestAnimationFrame ä»£è™Ÿ
4. æ–°å¢ drawBtn äº‹ä»¶ï¼Œæ‰èƒ½çœŸæ­£æŠŠçƒé¾œç•«åˆ°ç•«å¸ƒ
* -------------------------------- */

const canvas = document.getElementById('paper');
const ctx = canvas.getContext('2d');

const turtles = [];
let particles = [];
let burnRAF = null;
let burnStartTime = null;
let randomSunStyle = null;
const sunPos = { x: canvas.width / 2, y: canvas.height * 0.13, r: 120 };
const TEXT_OFFSET = 20;

/* å½±åƒè³‡æº */
const turtleImg      = new Image(); turtleImg.src      = 'turtle.png';
const sunImg         = new Image(); sunImg.src         = 'sun.png';
const fireImg        = new Image(); fireImg.src        = 'fire.png';
const turtleHandImg  = new Image(); turtleHandImg.src  = 'turtle_hand.png';
const sunHandImg     = new Image(); sunHandImg.src     = 'sun_hand.png';
const fireHandImg    = new Image(); fireHandImg.src    = 'fire_hand.png';

/* ---------- é€šç”¨ç¹ªåœ– ---------- */
function drawPaperBG(){
  ctx.fillStyle = '#FFFFF0';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawSun(){
  const mode  = document.getElementById('styleSelect').value;
  let style = mode;
  if(mode==='mix'){
    if(!randomSunStyle) randomSunStyle = Math.random()<0.5?'orig':'hand';
    style = randomSunStyle;
  }
  const img = style==='hand'?sunHandImg:sunImg;
  if(img.complete) ctx.drawImage(img,sunPos.x-sunPos.r,sunPos.y-sunPos.r,sunPos.r*2,sunPos.r*2);
}

function drawTurtle(inst){
  const {x,y,size,style} = inst;
  const facingRight = style==='hand' ? x>sunPos.x : inst.facingRight; //æ‰‹ç¹ªæ¨¡å¼å¼·åˆ¶æœå¤ªé™½
  const img = style==='hand'?turtleHandImg:turtleImg;
  ctx.save();
  ctx.translate(x,y);
  if(facingRight) ctx.scale(-1,1);
  if(img.complete) ctx.drawImage(img,-size/2,-size/2,size,size);
  ctx.restore();
}

function drawFooter(){
  const d = document.getElementById('dateInput').value || 'YYYY-MM-DD';
  const t = document.getElementById('timeInput').value || 'HH:MM';
  const l = document.getElementById('locInput').value  || 'åœ°é»';
  const y = sunPos.y + sunPos.r + TEXT_OFFSET;
  ctx.fillStyle='#000'; ctx.font='28px sans-serif'; ctx.textAlign='center';
  ctx.fillText(`${d}  ${t}`,canvas.width/2,y);
  ctx.fillText(l,canvas.width/2,y+32);
}

function renderScene(){
  drawPaperBG();
  drawSun();
  turtles.forEach(t=>drawTurtle(t));
  drawFooter();
}

/* ---------- çƒé¾œé¡ ---------- */
class Turtle{
  constructor(x,y,size,style){
    this.x=x; this.y=y; this.size=size; this.style=style;
    this.facingRight = x<canvas.width/2;
  }
}

/* ---------- ç«ç„°ç²’å­ ---------- */
class Particle{
  constructor(x,y){
    this.x=x; this.y=y;
    this.vx=(Math.random()-0.5)*3;
    this.vy=Math.random()*-3-1;
    this.size=10+Math.random()*30;
    this.life=0.4+Math.random()*0.6;
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.life-=0.02; }
  draw(){
    const mode=document.getElementById('styleSelect').value;
    const img = mode==='hand'?fireHandImg:mode==='orig'?fireImg:Math.random()<0.5?fireImg:fireHandImg;
    if(img.complete){
      ctx.globalAlpha=Math.max(this.life,0);
      ctx.shadowColor='orange'; ctx.shadowBlur=20;
      ctx.drawImage(img,this.x-this.size/2,this.y-this.size/2,this.size,this.size);
      ctx.globalAlpha=1; ctx.shadowBlur=0;
    }
  }
}

/* ---------- å‹•ç•« ---------- */
function burnStep(timestamp){
  if(!burnStartTime) burnStartTime = timestamp;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  renderScene();

  /* ç”Ÿæˆèˆ‡æ›´æ–°ç²’å­ */
  if(particles.length<200){
    turtles.forEach(t=>{
      particles.push(new Particle(t.x,t.y - t.size/2));
    });
  }
  particles.forEach(p=>p.update());
  particles = particles.filter(p=>p.life>0);
  particles.forEach(p=>p.draw());

  burnRAF = requestAnimationFrame(burnStep);
}

/* ---------- äº‹ä»¶ ---------- */
/* ç”¢ç”Ÿçƒé¾œ */
document.getElementById('drawBtn').addEventListener('click',()=>{
  const mode = document.getElementById('styleSelect').value;
  const count = 12;
  const radius = canvas.width*0.4;
  turtles.length = 0; // æ¸…ç©º
  for(let i=0;i<count;i++){
    const angle = Math.PI*1.2 + i*(Math.PI*0.6)/(count-1); // å·¦å³å„åŠ
    const x = canvas.width/2 + radius*Math.cos(angle);
    const y = canvas.height*0.65 + radius*Math.sin(angle)*0.4;
    const size = 80+Math.random()*40;
    turtles.push(new Turtle(x,y,size,mode==='mix'?(Math.random()<0.5?'orig':'hand'):mode));
  }
  randomSunStyle=null; // é‡æ–°æŠ½å¤ªé™½
  renderScene();
});

/* é»ç« */
document.getElementById('burnBtn').addEventListener('click',()=>{
  particles=[]; burnStartTime=null;
  cancelAnimationFrame(burnRAF);
  burnRAF = requestAnimationFrame(burnStep);
});

/* é‡ä¾† */
document.getElementById('resetBtn').addEventListener('click',()=>{
  turtles.length=0; particles=[]; burnStartTime=null; randomSunStyle=null;
  cancelAnimationFrame(burnRAF);
  renderScene();
});

/* åˆå§‹ç•«é¢ */
renderScene();
</script>
</body>
</html>
